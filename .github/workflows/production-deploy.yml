name: ğŸš€ Production Deploy

# Strategic triggering for production
on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
      - '#GUIDE/**'
      - 'deployment/README.md'
      - 'deployment/BRANCH_STRATEGY.md'
      - 'deployment/CICD_SETUP.md'

  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
      - '#GUIDE/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'Force deployment (skip some checks)'
        required: false
        default: false
        type: boolean

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'
  DOCKER_IMAGE: 'assassincreed2k1/hanaya-shop'

jobs:
  # ğŸ” Pre-flight validation
  validation:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      is-pr: ${{ steps.context.outputs.is-pr }}
      deploy-env: ${{ steps.context.outputs.deploy-env }}
      should-deploy: ${{ steps.context.outputs.should-deploy }}
      image-tag: ${{ steps.context.outputs.image-tag }}
      
    steps:
      - name: Analyze deployment context
        id: context
        run: |
          # Determine deployment context
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "is-pr=true" >> $GITHUB_OUTPUT
            echo "deploy-env=staging" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT  # PR = test only
            echo "image-tag=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "is-pr=false" >> $GITHUB_OUTPUT
            echo "deploy-env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "image-tag=manual-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "is-pr=false" >> $GITHUB_OUTPUT
            echo "deploy-env=production" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "image-tag=prod-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Display deployment info
        run: |
          echo "ğŸš€ Production Deployment Pipeline"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Is PR: ${{ steps.context.outputs.is-pr }}"
          echo "Environment: ${{ steps.context.outputs.deploy-env }}"
          echo "Will Deploy: ${{ steps.context.outputs.should-deploy }}"
          echo "Image Tag: ${{ steps.context.outputs.image-tag }}"

  # ğŸ§ª Comprehensive Testing
  comprehensive-tests:
    name: ğŸ§ª Pre-deployment Tests
    runs-on: ubuntu-latest
    needs: validation
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: hanaya_shop_prod_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, redis
          coverage: xdebug
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies and build
        run: |
          # Install with dev dependencies for testing phase (includes Faker, PHPUnit)
          # Production Docker build will use --no-dev
          composer install --no-interaction --prefer-dist --optimize-autoloader
          npm ci --production=false
          npm run build

      - name: Configure production-like environment
        run: |
          cp .env.example .env
          php artisan key:generate
          
          # Production-like database config
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=hanaya_shop_prod_test/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=password/' .env
          
          # Testing-friendly configuration that works with production-like setup
          echo "APP_ENV=testing" >> .env
          echo "APP_DEBUG=true" >> .env
          echo "REDIS_HOST=127.0.0.1" >> .env
          echo "REDIS_PORT=6379" >> .env
          echo "CACHE_DRIVER=array" >> .env
          echo "SESSION_DRIVER=array" >> .env
          echo "QUEUE_CONNECTION=sync" >> .env
          echo "MAIL_MAILER=array" >> .env
          echo "MAIL_FROM_ADDRESS=noreply@hanaya-shop.com" >> .env
          echo 'MAIL_FROM_NAME="Hanaya Shop"' >> .env
          echo "BCRYPT_ROUNDS=4" >> .env
          
          # Create a custom phpunit config for CI that uses MySQL
          cat > phpunit.ci.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
                   bootstrap="vendor/autoload.php"
                   colors="true"
          >
              id: test-execution
              continue-on-error: true
              run: |
                echo "ğŸ§ª Running comprehensive tests..."
                echo "test-status=success" >> $GITHUB_OUTPUT
                echo "ğŸ” Verifying test configuration..."
                if [ ! -f "phpunit.ci.xml" ]; then
                  echo "âŒ phpunit.ci.xml not found!"
                  exit 1
                fi
                echo "ğŸ” Testing database connection..."
                if ! php artisan migrate:status --database=mysql > /dev/null 2>&1; then
                  echo "âŒ Database connection failed!"
                  exit 1
                fi
                echo "âœ… Database connection verified"
                echo "ğŸ§ª Running Unit Tests..."
                php artisan test --testsuite=Unit --stop-on-failure --configuration=phpunit.ci.xml --log-junit=unit-report.xml || true
                if grep -q '<failure' unit-report.xml || grep -q '<error' unit-report.xml; then
                  echo "âŒ Unit tests failed!"
                  echo "test-status=unit-failed" >> $GITHUB_OUTPUT
                  exit 1
                else
                  echo "âœ… No real unit test failures. Skipped/risky tests are ignored."
                fi
                sleep 2
                php artisan cache:clear
                php artisan config:clear
                echo "ğŸ§ª Running Essential Feature Tests..."
                if ! php artisan test --testsuite=Feature --filter="ExampleTest|AuthenticationTest|PasswordConfirmationTest|PasswordUpdateTest|RegistrationTest" --stop-on-failure --configuration=phpunit.ci.xml; then
                  echo "âŒ Essential feature tests failed!"
                  echo "test-status=feature-failed" >> $GITHUB_OUTPUT
                  exit 1
                fi
                echo "âœ… All tests passed successfully"
          mkdir -p storage/{app/public,logs}
          mkdir -p bootstrap/cache
          chmod -R 755 storage bootstrap/cache
          
          # Clear any existing cache before optimization
          php artisan cache:clear || echo "Cache already clear"
          php artisan config:clear || echo "Config already clear"
          php artisan route:clear || echo "Routes already clear"
          php artisan view:clear || echo "Views already clear"
          
          # Optimize for production-like testing
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

      - name: Run database migrations
        run: |
          # Wait for MySQL to be ready
          echo "â³ Waiting for MySQL to be ready..."
          for i in {1..30}; do
            if php artisan migrate:status --database=mysql > /dev/null 2>&1; then
              echo "âœ… MySQL is ready"
              break
            fi
            echo "â³ Waiting for MySQL... ($i/30)"
            sleep 2
          done
          
          php artisan migrate --force --database=mysql
          
          # Seed basic data for feature tests
          php artisan db:seed --force --class=DatabaseSeeder --database=mysql || echo "âš ï¸ Seeding failed or not needed"

      - name: Debug test environment
        run: |
          echo "ğŸ” Debugging test environment..."
          echo "Current environment variables:"
          echo "APP_ENV: $APP_ENV"
          echo "DB_CONNECTION: $DB_CONNECTION"
          php artisan env
          
          echo "ğŸ” Checking auth configuration..."
          php artisan route:list | grep -E "(login|auth)" || echo "No auth routes found"
          
          echo "ğŸ” Testing basic functionality..."
          php artisan tinker --execute="echo 'PHP is working'; echo User::count();"
          
          echo "ğŸ” PHPUnit configuration check..."
          echo "Default phpunit.xml exists: $([ -f phpunit.xml ] && echo 'yes' || echo 'no')"
          echo "CI phpunit.ci.xml exists: $([ -f phpunit.ci.xml ] && echo 'yes' || echo 'no')"
          
          # Test database connection
          echo "ğŸ” Testing database connection..."
          php artisan migrate:status || echo "Migration status check failed"
          
      - name: Execute comprehensive test suite
        id: test-execution
        continue-on-error: true
        run: |
          echo "ğŸ§ª Running comprehensive tests..."
          
          # Set test status tracking
          echo "test-status=success" >> $GITHUB_OUTPUT
          
          # Verify test configuration before running tests
          echo "ğŸ” Verifying test configuration..."
          if [ ! -f "phpunit.ci.xml" ]; then
            echo "âŒ phpunit.ci.xml not found!"
            exit 1
          fi
          
          # Verify database connection before tests
          echo "ğŸ” Testing database connection..."
          if ! php artisan migrate:status --database=mysql > /dev/null 2>&1; then
            echo "âŒ Database connection failed!"
            exit 1
          fi
          echo "âœ… Database connection verified"
          
          # Core functionality tests (without parallel to avoid race conditions)
          echo "ğŸ§ª Running Unit Tests..."
          if ! php artisan test --testsuite=Unit --stop-on-failure --configuration=phpunit.ci.xml; then
            echo "âŒ Unit tests failed!"
            echo "test-status=unit-failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Unit tests passed"
          
          # Wait a moment for stability and clear caches
          sleep 2
          php artisan cache:clear
          php artisan config:clear
          
          # Essential feature tests with proper environment setup
          echo "ğŸ§ª Running Essential Feature Tests..."
          if ! php artisan test --testsuite=Feature --filter="ExampleTest|AuthenticationTest|PasswordConfirmationTest|PasswordUpdateTest|RegistrationTest" --stop-on-failure --configuration=phpunit.ci.xml; then
            echo "âŒ Essential feature tests failed!"
            echo "test-status=feature-failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… All tests passed successfully"
      
      - name: Handle test failures
        if: steps.test-execution.outcome == 'failure'
        run: |
          echo "âš ï¸ Tests failed in production deploy pipeline"
          echo "Test Status: ${{ steps.test-execution.outputs.test-status }}"
          
          if [[ "${{ steps.test-execution.outputs.test-status }}" == "unit-failed" ]]; then
            echo "âŒ Unit test failures indicate code quality issues"
            echo "ğŸ”´ Blocking deployment due to unit test failures"
            exit 1
          elif [[ "${{ steps.test-execution.outputs.test-status }}" == "feature-failed" ]]; then
            echo "âŒ Feature test failures indicate integration issues"
            echo "ğŸ”´ Blocking deployment due to feature test failures"
            exit 1
          fi
          
      - name: Test coverage and quality report
        if: steps.test-execution.outcome == 'success'
        run: |
          echo "ğŸ“Š Test Summary:"
          echo "âœ… Unit Tests: Passed"
          echo "âœ… Feature Tests: Passed"
          echo "ğŸ¯ Quality Gate: Met"
          echo "ğŸš€ Ready for deployment"
          
          # Code quality checks with better error handling
          echo "ğŸ¨ Running Laravel Pint checks..."
          if ! ./vendor/bin/pint --test; then
            echo "âŒ Code style issues found!"
            echo "ğŸ’¡ Run './vendor/bin/pint' locally to fix"
            exit 1
          fi
          echo "âœ… Code style checks passed"
          
          # Security audit with better handling
          echo "ğŸ”’ Running security audit..."
          if ! composer audit; then
            echo "âš ï¸ Security vulnerabilities detected - review required"
            # Don't fail on security issues, just warn
          fi
          
          if npm audit --audit-level=high; then
            echo "âœ… NPM security check passed"
          else
            echo "âš ï¸ NPM vulnerabilities detected"
          fi

      - name: Performance tests
        continue-on-error: true
        run: |
          echo "ğŸš€ Running performance tests..."
          # Basic performance check
          time php artisan config:cache
          time php artisan route:cache
          time php artisan view:cache

  # ğŸ³ Docker Build & Push
  docker-build:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [validation, comprehensive-tests]
    environment: ${{ needs.validation.outputs.deploy-env }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=commit-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ needs.validation.outputs.image-tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
          php artisan test --testsuite=Unit --stop-on-failure --configuration=phpunit.ci.xml --log-junit=unit-report.xml || true
          if grep -q '<failure' unit-report.xml || grep -q '<error' unit-report.xml; then
            echo "âŒ Unit tests failed!"
            echo "test-status=unit-failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… No real unit test failures. Skipped/risky tests are ignored."
          fi
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ needs.validation.outputs.image-tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'

  # ğŸš€ Production Deployment
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [validation, comprehensive-tests, docker-build]
    if: needs.validation.outputs.should-deploy == 'true'
    environment:
      name: ${{ needs.validation.outputs.deploy-env }}
      url: ${{ needs.validation.outputs.deploy-env == 'production' && 'http://www.hanayashop.com' || 'http://staging.hanayashop.com' }}
    
    steps:
      - name: Setup SSH Authentication
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Production Server
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=30 -o StrictHostKeyChecking=yes \
              ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'DEPLOYMENT_SCRIPT'
            
            set -euo pipefail  # Strict error handling
            
            echo "ï¿½ Starting production deployment..."
            echo "Target environment: ${{ needs.validation.outputs.deploy-env }}"
            echo "Image tag: ${{ needs.validation.outputs.image-tag }}"
            
            # Navigate to application directory
            cd /opt/hanaya-shop || {
              echo "âŒ Application directory not found at /opt/hanaya-shop"
              exit 1
            }
            
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ³ Current Docker status:"
            docker ps --filter name=hanaya --format "table {{.Names}}\t{{.Status}}" || echo "No containers running"
            
            # Stop conflicting services
            echo "ğŸ›‘ Stopping nginx to free port 80..."
            sudo systemctl stop nginx 2>/dev/null || echo "nginx not running"
            sudo systemctl disable nginx 2>/dev/null || echo "nginx already disabled"
            
            # Backup current state
            echo "ğŸ’¾ Creating deployment backup..."
            BACKUP_DIR="/opt/backups/$(date +%Y%m%d_%H%M%S)"
            sudo mkdir -p "$BACKUP_DIR"
            
            # Pull latest images
            echo "ï¿½ Pulling latest Docker images..."
            docker pull ${{ env.DOCKER_IMAGE }}:${{ needs.validation.outputs.image-tag }}
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # Execute deployment script
            echo "ğŸ”„ Executing deployment update..."
            cd scripts || {
              echo "âŒ Scripts directory not found"
              exit 1
            }
            
            # Set image tag for deployment script
            export NEW_IMAGE_TAG="${{ needs.validation.outputs.image-tag }}"
            ./update-image.sh || {
              echo "âŒ Deployment script failed"
              echo "ğŸ”„ Attempting rollback..."
              docker-compose down || true
              docker-compose up -d || echo "âŒ Rollback failed"
              exit 1
            }
            
            # Verification phase
            echo "ğŸ” Verifying deployment..."
            cd /opt/hanaya-shop
            
            # Wait for containers to be ready
            echo "â³ Waiting for containers to start..."
            sleep 10
            
            # Check container status
            if docker ps --filter name=hanaya --format "{{.Names}}" | grep -q hanaya; then
              echo "âœ… Containers are running:"
              docker ps --filter name=hanaya --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            else
              echo "âŒ No hanaya containers found running"
              exit 1
            fi
            
            # Health check with retry
            echo "ğŸ¥ Performing health checks..."
            RETRY_COUNT=0
            MAX_RETRIES=6
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f --max-time 10 http://localhost > /dev/null 2>&1; then
                echo "âœ… Application is healthy and responding!"
                echo "ğŸŒ Website is live with latest updates!"
                
                # Additional checks
                echo "ğŸ“Š Application metrics:"
                docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" | head -3
                
                echo "ğŸ‰ Production deployment completed successfully!"
                exit 0
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
                sleep 5
              fi
            done
            
            echo "âš ï¸ Health checks failed after $MAX_RETRIES attempts"
            echo "ğŸ’¡ Deployment completed but application may need manual verification"
            echo "ğŸ” Check logs: docker logs hanaya-web"
            echo "ï¿½ï¸ Try clearing browser cache (Ctrl+Shift+R)"
            
          DEPLOYMENT_SCRIPT

      - name: Post-deployment validation
        run: |
          echo "âœ… Deployment pipeline completed!"
          echo "ğŸ³ Docker Image: ${{ env.DOCKER_IMAGE }}:${{ needs.validation.outputs.image-tag }}"
          echo "ğŸŒ Environment: ${{ needs.validation.outputs.deploy-env }}"
          
          if [[ "${{ needs.validation.outputs.deploy-env }}" == "production" ]]; then
            echo "ğŸš€ Production URL: http://www.hanayashop.com"
          else
            echo "ğŸš€ Staging URL: http://staging.hanayashop.com"
          fi

  # ğŸ“Š Deployment Summary
  summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [validation, comprehensive-tests, docker-build, deploy]
    if: always()
    
    steps:
      - name: Generate deployment summary
        run: |
          echo "## ğŸš€ Production Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Validation | ${{ needs.validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Environment: ${{ needs.validation.outputs.deploy-env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Tests | ${{ needs.comprehensive-tests.result == 'success' && 'âœ… All Passed' || 'âŒ Failed' }} | Production-ready validation |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Docker Build | ${{ needs.docker-build.result == 'success' && 'âœ… Built & Pushed' || 'âŒ Failed' }} | Tag: ${{ needs.validation.outputs.image-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Deployment | ${{ needs.deploy.result == 'success' && 'âœ… Deployed' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped (PR)' || 'âŒ Failed' }} | Target: ${{ needs.validation.outputs.deploy-env }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "### ğŸ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "The application has been successfully deployed to ${{ needs.validation.outputs.deploy-env }}." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ Verify the application at the deployment URL" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š Monitor application metrics and logs" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”„ Update documentation if needed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.validation.outputs.is-pr }}" == "true" ]]; then
            echo "### âœ… PR Validation Complete" >> $GITHUB_STEP_SUMMARY
            echo "All tests passed! This PR is ready for review and merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Deployment Issues" >> $GITHUB_STEP_SUMMARY
            echo "Some stages failed. Please review the logs and retry if necessary." >> $GITHUB_STEP_SUMMARY
          fi